<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyATODPEPLVaVg_Alrdet9flGaUpIOc8HD0",
        authDomain: "asep-bbc34.firebaseapp.com",
        projectId: "asep-bbc34",
        storageBucket: "asep-bbc34.appspot.com",
        messagingSenderId: "649819916593",
        appId: "1:649819916593:web:7544bda86e7bae47f24810"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Add authentication state listener
    auth.onAuthStateChanged(user => {
        if (!user) {
            auth.signInAnonymously().catch(error => {
                console.error("Authentication error:", error);
                showStatus('Authentication failed. Please refresh the page.', 'error', 'bookingStatus');
            });
        }
    });

    const cropDatabase = [
            {
                name: "Tomato",
                ph: [5.5, 7.0],
                humidity: "moderate",
                temp: [18, 30],
                water: "Regular watering",
                nutrients: "N-P-K: 5-10-5",
                duration: "70-90 days"
            },
            {
                name: "Rice",
                ph: [5.0, 6.5],
                humidity: "high",
                temp: [20, 35],
                water: "Flood irrigation",
                nutrients: "N-P-K: 10-5-5",
                duration: "110-130 days"
            },
            {
                name: "Wheat",
                ph: [6.0, 7.5],
                humidity: "moderate",
                temp: [15, 25],
                water: "Moderate irrigation",
                nutrients: "N-P-K: 12-6-4",
                duration: "120-140 days"
            },
            {
                name: "Carrot",
                ph: [6.0, 7.0],
                humidity: "moderate",
                temp: [15, 25],
                water: "Regular watering",
                nutrients: "N-P-K: 3-12-12",
                duration: "70-80 days"
            },
            {
                name: "Potato",
                ph: [4.8, 6.5],
                humidity: "moderate",
                temp: [15, 20],
                water: "Consistent moisture",
                nutrients: "N-P-K: 5-10-10",
                duration: "90-120 days"
            },
            {
                name: "Corn",
                ph: [5.8, 7.0],
                humidity: "moderate",
                temp: [21, 30],
                water: "Deep watering",
                nutrients: "N-P-K: 10-10-10",
                duration: "60-100 days"
            },
            {
                name: "Spinach",
                ph: [6.0, 7.5],
                humidity: "high",
                temp: [10, 20],
                water: "Frequent light watering",
                nutrients: "N-P-K: 4-6-3",
                duration: "40-50 days"
            }
        ];

    async function bookSoilTest() {
        const user = auth.currentUser;
        if (!user) {
            showStatus('Please wait while we authenticate your session...', 'error', 'bookingStatus');
            return;
        }

        const bookingData = {
            uid: user.uid,
            name: document.getElementById('userName').value.trim(),
            email: document.getElementById('userEmail').value.trim(),
            phone: document.getElementById('userPhone').value.trim(),
            location: document.getElementById('userLocation').value.trim(),
            date: document.getElementById('testDate').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        
         // Validation
         if (!bookingData.name || !bookingData.email || !bookingData.phone || !bookingData.location || !bookingData.date) {
            showStatus('Please fill all required fields!', 'error', 'bookingStatus');
            return;
        }

        try {
            await db.collection('soilTests').add(bookingData);
            showStatus(`Booking successful! Report will be sent to ${bookingData.email}`, 'success', 'bookingStatus');
            clearForm();
        } catch (error) {
            console.error('Booking error:', error);
            showStatus(`Booking failed: ${error.message}`, 'error', 'bookingStatus');
        }
    }
</script>
