<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Signup</title>
    <!-- Firebase SDK (use compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: url('https://t3.ftcdn.net/jpg/08/04/22/42/240_F_804224219_QdNW7DlskOWvDzon8xM4LQuxX62bdvdm.jpg') no-repeat center center fixed;
        background-size: cover;
    }

    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        backdrop-filter: blur(5px);
    }

    .form-container {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        text-align: center;
        width: 300px;
    }
        .cf-turnstile {
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }

    .form-container h2 {
        margin-bottom: 20px;
        color: #2c3e50;
    }

    .form-container input {
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        width: 100%;
        box-sizing: border-box;
    }

    .form-container button {
        padding: 10px;
        margin: 10px 0;
        background-color: #27ae60;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }

    .form-container button:hover {
        background-color: #2ecc71;
    }

    .toggle-link {
        color: #3498db;
        text-decoration: none;
        cursor: pointer;
    }

    .toggle-link:hover {
        text-decoration: underline;
    }

    .error-message {
        color: red;
        margin: 10px 0;
    }

    .hidden {
        display: none;
    }
</style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
       <div class="form-container" id="login-form">
  <h2>Login</h2>
  <form id="loginForm">
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="password" id="login-password" placeholder="Password" required>
    <div id="login-error" class="error-message"></div>
    <!-- Add CAPTCHA to the submit button -->
    <button type="submit" class="cf-turnstile-submit" 
            data-sitekey="0x4AAAAAAA-HUBpovgMUuiTc" 
            data-callback="onLoginCaptchaSuccess">
      Login
    </button>
  </form>
  <p>Don't have an account? <span class="toggle-link" onclick="showSignup()">Sign up here</span></p>
</div>

<!-- Signup Form -->
<div class="form-container hidden" id="signup-form">
  <h2>Sign Up</h2>
  <form id="signupForm">
    <input type="email" id="signup-email" placeholder="Email" required>
    <input type="password" id="signup-password" placeholder="Password (6+ characters)" required>
    <div id="signup-error" class="error-message"></div>
    <!-- Add CAPTCHA to the submit button -->
    <button type="submit" class="cf-turnstile-submit" 
            data-sitekey="0x4AAAAAAA-HUBpovgMUuiTc" 
            data-callback="onSignupCaptchaSuccess">
      Create Account
    </button>
  </form>
  <p>Already have an account? <span class="toggle-link" onclick="showLogin()">Login here</span></p>
</div>
    </div>

     <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyATODPEPLVaVg_Alrdet9flGaUpIOc8HD0",
            authDomain: "asep-bbc34.firebaseapp.com",
            projectId: "asep-bbc34",
            storageBucket: "asep-bbc34.firebasestorage.app",
            messagingSenderId: "649819916593",
            appId: "1:649819916593:web:7544bda86e7bae47f24810"
        };

        // Initialize Firebase
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // CAPTCHA tokens storage
       // Track CAPTCHA tokens
let loginCaptchaToken = null;
let signupCaptchaToken = null;

// Initialize CAPTCHA for all buttons with class 'cf-turnstile-submit'
document.addEventListener('DOMContentLoaded', () => {
  turnstile.render('.cf-turnstile-submit', {
    sitekey: '0x4AAAAAAA-HUBpovgMUuiTc',
    execution: 'execute', // Delay rendering until button click
  });
});

// Login CAPTCHA success callback
async function onLoginCaptchaSuccess(token) {
  loginCaptchaToken = token;
  await handleLogin(); // Proceed with login after CAPTCHA
}

// Signup CAPTCHA success callback
async function onSignupCaptchaSuccess(token) {
  signupCaptchaToken = token;
  await handleSignup(); // Proceed with signup after CAPTCHA
}

// Handle login after CAPTCHA verification
async function handleLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  try {
    await auth.signInWithEmailAndPassword(email, password);
    window.location.href = 'homepage.html';
  } catch (error) {
    showError('login-error', getErrorMessage(error));
    // Reset CAPTCHA on failure
    turnstile.reset('#loginForm .cf-turnstile-submit');
    loginCaptchaToken = null;
  }
}

// Handle signup after CAPTCHA verification
async function handleSignup() {
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;

  try {
    await auth.createUserWithEmailAndPassword(email, password);
    alert('Account created successfully! Please login.');
    showLogin();
  } catch (error) {
    showError('signup-error', getErrorMessage(error));
    // Reset CAPTCHA on failure
    turnstile.reset('#signupForm .cf-turnstile-submit');
    signupCaptchaToken = null;
  }
}

// Remove old form submission event listeners (original code)
// document.getElementById('loginForm').removeEventListener('submit', login);
// document.getElementById('signupForm').removeEventListener('submit', signup);

        async function login(e) {
            e.preventDefault();
            if (!loginCaptchaToken) {
                showError('login-error', 'Please complete the CAPTCHA');
                return;
            }

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                window.location.href = 'homepage.html';
            } catch (error) {
                showError('login-error', getErrorMessage(error));
                turnstile.reset('#login-captcha');
                loginCaptchaToken = null;
            }
        }

        async function signup(e) {
            e.preventDefault();
            if (!signupCaptchaToken) {
                showError('signup-error', 'Please complete the CAPTCHA');
                return;
            }

            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                alert('Account created successfully! Please login.');
                showLogin();
            } catch (error) {
                showError('signup-error', getErrorMessage(error));
                turnstile.reset('#signup-captcha');
                signupCaptchaToken = null;
            }
        }

        // Keep existing helper functions the same
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            setTimeout(() => errorElement.textContent = '', 5000);
        }

        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/email-already-in-use': return 'Email already registered';
                case 'auth/invalid-email': return 'Invalid email address';
                case 'auth/weak-password': return 'Password must be at least 6 characters';
                case 'auth/user-not-found': return 'Account not found';
                case 'auth/wrong-password': return 'Incorrect password';
                default: return 'Authentication failed. Please try again.';
            }
        }

        function showLogin() {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            turnstile.reset('#login-captcha');
            loginCaptchaToken = null;
        }

        function showSignup() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('signupForm').reset();
            turnstile.reset('#signup-captcha');
            signupCaptchaToken = null;
        }
    </script>
</body>
</html>
